#!/usr/bin/env bash

FIRST_NAME="Firstname"
LAST_NAME="Lastname"
FULL_NAME="$FIRST_NAME $LAST_NAME"
EMAIL="firstname.lastname@example.com"

echo "Starting bootstrapping"

# Create the projects folder
mkdir ~/dev

# Oh My Zsh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Fix permissions
chmod g-w,o-w /usr/local/share/zsh /usr/local/share/zsh/site-functions

###############################################################################
# Node, NPM and Yarn                                                          #
###############################################################################

# Install NVM
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.40.3/install.sh | bash

# Install latest Node
nvm install node

# Install Yarn
# npm install --global yarn

# NPM update checker
# npm install -g npm-check-updates

###############################################################################
# Homebrew                                                                    #
###############################################################################

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.bootstrap` has finished
while true; do
    sudo -n true
    sleep 60
    kill -0 "$$" || exit
done 2>/dev/null &

# Check for Homebrew, install if we don't have it
if test ! $(which brew); then
    echo "Installing homebrew..."
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Update homebrew recipes
brew update

PACKAGES=(
    tmux
    cloc
    git
    ripgrep
)

echo "Installing packages..."
brew install ${PACKAGES[@]}

echo "Cleaning up..."
brew cleanup

###############################################################################
# Git                                                                         #
###############################################################################

# Remove default Git (installed previously with Homebrew)
sudo mv /usr/bin/git /usr/bin/git-apple

git config --global user.name "$FULL_NAME"
git config --global user.email "$EMAIL"
git config --global color.ui true

###############################################################################
# SSH                                                                         #
###############################################################################

# Generate SSH keys
ssh-keygen -t rsa -C "$EMAIL" -f ~/.ssh/id_rsa

###############################################################################
# Misc                                                                        #
###############################################################################

# Use `code` to open VS Code from command line
cat <<EOF >>~/.zprofile
# Add Visual Studio Code (code)
export PATH="\$PATH:/Applications/Visual Studio Code.app/Contents/Resources/app/bin"
EOF

# Copy .zprofile and .tmux.conf to home directory
cp configuration/.zprofile ~/.zprofile
cp configuration/.tmux.conf ~/.tmux.conf

# Enable changes
source ~/.zshrc
source ~/.zprofile
source ~/.tmux.conf

printf "\n\nBootstrapping complete"
printf "\n\nGet your public SSH key: cat ~/.ssh/id_rsa.pub\n\n"
